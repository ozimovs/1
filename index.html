<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeFi Stable</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root, [data-theme="dark"] {
    --bg: #0a0d12;
    --surface: #111520;
    --surface2: #181e2e;
    --border: #1e2a40;
    --accent: #00e5a0;
    --accent-dark: #008c5a;
    --accent2: #3b82f6;
    --warn: #f59e0b;
    --danger: #ef4444;
    --text: #e2e8f0;
    --muted: #4a5568;
    --muted2: #718096;
    --btn-primary-text: #0a0d12;
  }

  [data-theme="light"] {
    --bg: #f1f5f9;
    --surface: #ffffff;
    --surface2: #e2e8f0;
    --border: #cbd5e1;
    --accent: #059669;
    --accent-dark: #047857;
    --accent2: #2563eb;
    --warn: #d97706;
    --danger: #dc2626;
    --text: #1e293b;
    --muted: #64748b;
    --muted2: #94a3b8;
    --btn-primary-text: #ffffff;
  }

  [data-theme="light"] body::before { opacity: 0.15; }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    padding: 24px;
    transition: background 0.3s, color 0.3s;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
  }

  .wrapper { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; }

  /* Header */
  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .logo-block h1 {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .logo-block h1 span { color: var(--accent); }

  .logo-block p {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--muted2);
    margin-top: 4px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .header-stats {
    display: flex;
    gap: 32px;
    align-items: flex-end;
  }

  .stat-pill {
    text-align: right;
  }

  .stat-pill .label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--muted2);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stat-pill .value {
    font-size: 22px;
    font-weight: 800;
    color: var(--accent);
    font-family: 'Space Mono', monospace;
  }

  .stat-pill .value.neutral { color: var(--text); }
  .stat-pill .value.yield-dark-green { color: var(--accent-dark) !important; }
  .stat-pill .value.yield-green { color: var(--accent) !important; }
  .stat-pill .value.yield-yellow { color: var(--warn) !important; }
  .stat-pill .value.yield-gray { color: var(--muted2) !important; }
  .stat-pill .value.yield-danger { color: var(--danger) !important; }

  /* Action bar */
  .action-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.3px;
  }

  .btn-primary {
    background: var(--accent);
    color: var(--btn-primary-text);
  }

  .btn-primary:hover { background: #00ffb2; transform: translateY(-1px); }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  .btn-danger {
    background: transparent;
    color: var(--danger);
    border: 1px solid var(--danger);
  }

  .btn-danger:hover { background: var(--danger); color: white; }

  /* Filter tabs */
  .filter-tabs {
    display: flex;
    gap: 4px;
    margin-left: auto;
    background: var(--surface);
    padding: 4px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  .tab {
    padding: 6px 16px;
    border-radius: 5px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    color: var(--muted2);
    transition: all 0.15s;
    font-family: 'Space Mono', monospace;
  }

  .tab.active {
    background: var(--accent);
    color: var(--btn-primary-text);
  }

  .tab:not(.active):hover { color: var(--text); }

  /* Table */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead tr {
    background: var(--surface2);
    border-bottom: 2px solid var(--border);
  }

  thead th {
    padding: 14px 16px;
    text-align: left;
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted2);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.15s;
  }

  thead th:hover { color: var(--accent); }

  thead th .sort-icon { opacity: 0.4; margin-left: 4px; }
  thead th.sorted .sort-icon { opacity: 1; color: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
    animation: rowIn 0.3s ease forwards;
    opacity: 0;
  }

  @keyframes rowIn {
    from { opacity: 0; transform: translateX(-8px); }
    to { opacity: 1; transform: translateX(0); }
  }

  tbody tr:hover { background: rgba(0, 229, 160, 0.04); }
  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 14px 16px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    vertical-align: middle;
  }

  td.protocol {
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
  }

  .protocol-icon {
    display: inline-flex;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 800;
    margin-right: 10px;
    vertical-align: middle;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--accent);
  }

  .badge-status {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-open { background: rgba(0, 229, 160, 0.1); color: var(--accent); border: 1px solid rgba(0, 229, 160, 0.3); }
  .badge-closed { background: rgba(100, 116, 139, 0.15); color: var(--muted2); border: 1px solid var(--border); }

  .yield-bar {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .yield-track {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    min-width: 60px;
    overflow: hidden;
  }

  .yield-fill {
    height: 100%;
    border-radius: 2px;
    background: var(--accent);
    transition: width 0.6s ease;
  }

  .profit-pos { color: var(--accent); }
  .profit-neg { color: var(--danger); }
  .profit-zero { color: var(--muted2); }

  .apy-very-high { color: var(--accent-dark) !important; font-weight: 700; }
  .apy-high { color: var(--accent) !important; font-weight: 700; }
  .apy-mid { color: var(--warn); }
  .apy-low { color: var(--muted2); }

  td .actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.15s; }
  tr:hover td .actions { opacity: 1; }

  .icon-btn {
    width: 28px; height: 28px;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted2);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    transition: all 0.15s;
  }

  .icon-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,229,160,0.05); }
  .icon-btn.del:hover { border-color: var(--danger); color: var(--danger); background: rgba(239,68,68,0.05); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted2);
  }

  .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }
  .empty-state p { font-family: 'Space Mono', monospace; font-size: 12px; }

  /* Modal */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 100;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .modal-backdrop.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 24px 64px rgba(0,0,0,0.5);
    animation: modalIn 0.2s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal h2 {
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 24px;
    color: var(--text);
  }

  .modal h2 span { color: var(--accent); }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-group.full { grid-column: 1 / -1; }

  label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted2);
  }

  input, select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 12px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    transition: border-color 0.15s;
    outline: none;
  }

  input:focus, select:focus { border-color: var(--accent); }

  select option { background: var(--surface2); }

  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 24px;
    justify-content: flex-end;
  }

  /* Summary cards */
  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), transparent);
  }

  .card:hover { border-color: rgba(0, 229, 160, 0.3); }

  .card .c-label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted2);
    margin-bottom: 8px;
  }

  .card .c-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--text);
    font-family: 'Space Mono', monospace;
  }

  .card .c-value.dark-green { color: var(--accent-dark); }
  .card .c-value.green { color: var(--accent); }
  .card .c-value.yellow { color: var(--warn); }
  .card .c-value.gray { color: var(--muted2); }

  /* Export button animation */
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(0,229,160,0.4); }
    50% { box-shadow: 0 0 0 6px rgba(0,229,160,0); }
  }

  .pulse { animation: pulse 2s infinite; }

  /* Chat widget button (shown when Tawk.to not configured) */
  .chat-widget-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--accent);
    color: var(--btn-primary-text);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 229, 160, 0.4);
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .chat-widget-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 24px rgba(0, 229, 160, 0.5);
  }

  /* Theme & Lang toggles */
  .header-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .toggle-group {
    display: flex;
    align-items: center;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px;
    gap: 2px;
  }
  .toggle-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    background: transparent;
    color: var(--muted2);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    transition: all 0.15s;
  }
  .toggle-btn:hover { color: var(--text); }
  .toggle-btn.active {
    background: var(--accent);
    color: var(--btn-primary-text);
  }
  .toggle-btn.theme-btn { padding: 6px 10px; font-size: 14px; }

  /* DeBank load */
  .debank-load {
    display: flex;
    gap: 10px;
    align-items: flex-end;
    flex-wrap: wrap;
  }
  .debank-load input {
    width: 320px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
  }
  .debank-load .btn { flex-shrink: 0; }
  .debank-result {
    margin-top: 12px;
    padding: 12px 16px;
    background: var(--surface2);
    border-radius: 8px;
    border: 1px solid var(--border);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
  }
  .debank-result.loading { color: var(--muted2); }
  .debank-result.error { color: var(--danger); }
  .debank-result .total { font-size: 18px; font-weight: 700; color: var(--accent); margin-bottom: 8px; }

  /* Responsive */
  @media (max-width: 900px) {
    .form-grid { grid-template-columns: 1fr; }
    .form-group.full { grid-column: 1; }
    header { flex-direction: column; gap: 20px; align-items: flex-start; }
    .header-stats { justify-content: flex-start; }
    .header-controls { flex-shrink: 0; }
  }
</style>
</head>
<body>
<div class="wrapper">

  <header>
    <div style="display:flex; align-items:flex-end; gap:24px;">
      <div class="logo-block">
        <h1>DeFi <span>Stable</span></h1>
        <p data-i18n="subtitle">–£—á—ë—Ç –ø–æ–∑–∏—Ü–∏–π ¬∑ Yield Tracker</p>
      </div>
      <div class="header-controls">
      <div class="toggle-group">
        <button class="toggle-btn theme-btn active" id="themeDark" onclick="setTheme('dark')" title="Dark" aria-label="Dark">üåô</button>
        <button class="toggle-btn theme-btn" id="themeLight" onclick="setTheme('light')" title="Light" aria-label="Light">‚òÄÔ∏è</button>
      </div>
      <div class="toggle-group">
        <button class="toggle-btn active" id="langRu" onclick="setLang('ru')">RU</button>
        <button class="toggle-btn" id="langEn" onclick="setLang('en')">EN</button>
      </div>
      <a href="debank.html" class="btn btn-secondary" style="padding:6px 14px; font-size:12px;" data-i18n="debankNav">üì° DeBank</a>
    </div>
    </div>
    <div class="header-stats">
      <div class="stat-pill">
        <div class="label" data-i18n="totalDeposited">–í—Å–µ–≥–æ –≤–ª–æ–∂–µ–Ω–æ</div>
        <div class="value neutral" id="totalDeposit">‚Äî</div>
      </div>
      <div class="stat-pill">
        <div class="label" data-i18n="profit">–ü—Ä–∏–±—ã–ª—å</div>
        <div class="value" id="totalProfit">‚Äî</div>
      </div>
      <div class="stat-pill">
        <div class="label" data-i18n="currentYield">–¢–µ–∫—É—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
        <div class="value" id="totalYield">‚Äî</div>
      </div>
    </div>
  </header>

  <div class="summary-cards">
    <div class="card">
      <div class="c-label" data-i18n="openPositions">–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</div>
      <div class="c-value green" id="openCount">0</div>
    </div>
    <div class="card">
      <div class="c-label" data-i18n="closedPositions">–ó–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</div>
      <div class="c-value" id="closedCount">0</div>
    </div>
    <div class="card">
      <div class="c-label" data-i18n="avgYield">–°—Ä–µ–¥–Ω—è—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
      <div class="c-value" id="avgYield">0.00%</div>
    </div>
    <div class="card">
      <div class="c-label" data-i18n="bestProtocol">–õ—É—á—à–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª</div>
      <div class="c-value green" id="bestProtocol" style="font-size:16px;">‚Äî</div>
    </div>
  </div>

  <div class="debank-load" style="margin-bottom:20px;flex-wrap:wrap;">
    <div class="form-group" style="margin:0;">
      <label data-i18n="debankWallet">–ö–æ—à–µ–ª—ë–∫ DeBank</label>
      <input type="text" id="debankAddr" placeholder="0x...">
    </div>
    <button class="btn btn-secondary" onclick="loadFromDebank()" data-i18n="loadFromDebank">üì° –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <div class="debank-result" id="debankResult" style="display:none;flex-basis:100%;"></div>
  </div>

  <div class="action-bar">
    <button class="btn btn-primary pulse" onclick="openModal()" data-i18n="addPosition">Ôºã –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
    <a href="debank.html" class="btn btn-secondary" data-i18n="debankAssets">üì° DeBank –∞–∫—Ç–∏–≤—ã</a>
    <button class="btn btn-secondary" onclick="exportCSV()" data-i18n="exportCsv">‚¨á –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <div class="filter-tabs">
      <div class="tab active" onclick="setFilter('all', this)" data-i18n="filterAll">ALL</div>
      <div class="tab" onclick="setFilter('open', this)" data-i18n="filterOpen">OPEN</div>
      <div class="tab" onclick="setFilter('closed', this)" data-i18n="filterClosed">CLOSED</div>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('protocol')"><span data-i18n="protocol">–ü—Ä–æ—Ç–æ–∫–æ–ª</span> <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('dateOpen')"><span data-i18n="dateOpen">–î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è</span> <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('deposited')"><span data-i18n="deposited">–°—É–º–º–∞ –≤–Ω–µ—Å–µ–Ω–∞</span> <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('daysOpen')"><span data-i18n="daysInPosition">–î–Ω–µ–π –≤ –ø–æ–∑–∏—Ü–∏–∏</span> <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('currentValue')"><span data-i18n="currentValue">–¢–µ–∫. —Å—Ç–æ–∏–º–æ—Å—Ç—å</span> <span class="sort-icon">‚Üï</span></th>
          <th data-i18n="updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
          <th onclick="sortBy('profit')"><span data-i18n="profit">–ü—Ä–∏–±—ã–ª—å</span> <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('returnPct')"><span data-i18n="yield">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</span> <span class="sort-icon">‚Üï</span></th>
          <th data-i18n="apyEstimate">APY (–æ—Ü–µ–Ω–∫–∞)</th>
          <th data-i18n="status">–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="icon">üìä</div>
      <p data-i18n="noPositions">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>
    </div>
  </div>

</div>

<!-- Chat widget: replace your_username with your Telegram, or configure Tawk.to below -->
<a href="https://t.me/your_username" target="_blank" rel="noopener" class="chat-widget-btn" id="chatWidgetBtn" data-i18n-title="chat" title="–ß–∞—Ç" aria-label="–ß–∞—Ç">
  üí¨
</a>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop" onclick="closeModalOutside(event)">
  <div class="modal">
    <h2 id="modalTitle">–ù–æ–≤–∞—è <span>–ø–æ–∑–∏—Ü–∏—è</span></h2>
    <div class="form-grid">
      <div class="form-group full">
        <label data-i18n="protocolLabel">–ü—Ä–æ—Ç–æ–∫–æ–ª / DeFi-–ø—Ä–æ—Ç–æ–∫–æ–ª</label>
        <input type="text" id="f_protocol" placeholder="Avantis, Convex...">
      </div>
      <div class="form-group">
        <label data-i18n="dateOpen">–î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è</label>
        <input type="date" id="f_dateOpen">
      </div>
      <div class="form-group">
        <label data-i18n="dateClose">–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</label>
        <input type="date" id="f_dateClose">
      </div>
      <div class="form-group">
        <label data-i18n="deposited">–°—É–º–º–∞ –≤–Ω–µ—Å–µ–Ω–∞</label>
        <input type="number" id="f_deposited" placeholder="0">
      </div>
      <div class="form-group">
        <label data-i18n="currentValue">–¢–µ–∫. —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
        <input type="number" id="f_currentValue" placeholder="0">
      </div>
      <div class="form-group">
        <label data-i18n="withdrawn">–í—ã–≤–µ–¥–µ–Ω–æ</label>
        <input type="number" id="f_withdrawn" placeholder="0">
      </div>
      <div class="form-group">
        <label data-i18n="status">–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
        <select id="f_status">
          <option value="open">Open</option>
          <option value="closed">Closed</option>
        </select>
      </div>
      <div class="form-group">
        <label data-i18n="note">–ó–∞–º–µ—Ç–∫–∞</label>
        <input type="text" id="f_note">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="savePosition()" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ i18n & Theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const LANG_KEY = 'defi_lang';
const THEME_KEY = 'defi_theme';

const t = {
  ru: {
    subtitle: '–£—á—ë—Ç –ø–æ–∑–∏—Ü–∏–π ¬∑ Yield Tracker',
    totalDeposited: '–í—Å–µ–≥–æ –≤–ª–æ–∂–µ–Ω–æ',
    profit: '–ü—Ä–∏–±—ã–ª—å',
    currentYield: '–¢–µ–∫—É—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å',
    openPositions: '–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π',
    closedPositions: '–ó–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π',
    avgYield: '–°—Ä–µ–¥–Ω—è—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å',
    bestProtocol: '–õ—É—á—à–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª',
    addPosition: 'Ôºã –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é',
    exportCsv: '‚¨á –≠–∫—Å–ø–æ—Ä—Ç CSV',
    protocol: '–ü—Ä–æ—Ç–æ–∫–æ–ª',
    dateOpen: '–î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è',
    dateClose: '–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è',
    deposited: '–°—É–º–º–∞ –≤–Ω–µ—Å–µ–Ω–∞',
    daysInPosition: '–î–Ω–µ–π –≤ –ø–æ–∑–∏—Ü–∏–∏',
    currentValue: '–¢–µ–∫. —Å—Ç–æ–∏–º–æ—Å—Ç—å',
    updated: '–û–±–Ω–æ–≤–ª–µ–Ω–æ',
    yield: '–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å',
    apyEstimate: 'APY (–æ—Ü–µ–Ω–∫–∞)',
    status: '–°–æ—Å—Ç–æ—è–Ω–∏–µ',
    noPositions: '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!',
    newPosition: '–ù–æ–≤–∞—è',
    editPosition: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
    position: '–ø–æ–∑–∏—Ü–∏—è',
    protocolLabel: '–ü—Ä–æ—Ç–æ–∫–æ–ª / DeFi-–ø—Ä–æ—Ç–æ–∫–æ–ª',
    withdrawn: '–í—ã–≤–µ–¥–µ–Ω–æ',
    note: '–ó–∞–º–µ—Ç–∫–∞',
    cancel: '–û—Ç–º–µ–Ω–∞',
    save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    enterProtocol: '–£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ–∫–æ–ª',
    deleteConfirm: '–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é?',
    edit: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
    delete: '–£–¥–∞–ª–∏—Ç—å',
    chat: '–ß–∞—Ç',
    filterAll: 'ALL',
    filterOpen: 'OPEN',
    filterClosed: 'CLOSED',
    debankWallet: '–ö–æ—à–µ–ª—ë–∫ DeBank',
    loadFromDebank: 'üì° –ó–∞–≥—Ä—É–∑–∏—Ç—å',
    debankTotal: '–ë–∞–ª–∞–Ω—Å',
    debankError: '–û—à–∏–±–∫–∞',
    debankLoading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
    debankAssets: 'üì° DeBank –∞–∫—Ç–∏–≤—ã',
    debankNav: 'üì° DeBank'
  },
  en: {
    subtitle: 'Position tracking ¬∑ Yield Tracker',
    totalDeposited: 'Total deposited',
    profit: 'Profit',
    currentYield: 'Current yield',
    openPositions: 'Open positions',
    closedPositions: 'Closed positions',
    avgYield: 'Average yield',
    bestProtocol: 'Best protocol',
    addPosition: 'Ôºã Add position',
    exportCsv: '‚¨á Export CSV',
    protocol: 'Protocol',
    dateOpen: 'Date open',
    dateClose: 'Date close',
    deposited: 'Deposited',
    daysInPosition: 'Days in position',
    currentValue: 'Current value',
    updated: 'Updated',
    yield: 'Yield',
    apyEstimate: 'APY (est.)',
    status: 'Status',
    noPositions: 'No positions. Add the first one!',
    newPosition: 'New',
    editPosition: 'Edit',
    position: 'position',
    protocolLabel: 'Protocol / DeFi protocol',
    withdrawn: 'Withdrawn',
    note: 'Note',
    cancel: 'Cancel',
    save: 'Save',
    enterProtocol: 'Enter protocol',
    deleteConfirm: 'Delete position?',
    edit: 'Edit',
    delete: 'Delete',
    chat: 'Chat',
    filterAll: 'ALL',
    filterOpen: 'OPEN',
    filterClosed: 'CLOSED',
    debankWallet: 'DeBank Wallet',
    loadFromDebank: 'üì° Load',
    debankTotal: 'Balance',
    debankError: 'Error',
    debankLoading: 'Loading...',
    debankAssets: 'üì° DeBank assets',
    debankNav: 'üì° DeBank'
  }
};

let lang = localStorage.getItem(LANG_KEY) || 'ru';
let theme = localStorage.getItem(THEME_KEY) || 'dark';

function setTheme(val) {
  theme = val;
  localStorage.setItem(THEME_KEY, val);
  document.documentElement.setAttribute('data-theme', val);
  document.getElementById('themeDark').classList.toggle('active', val === 'dark');
  document.getElementById('themeLight').classList.toggle('active', val === 'light');
}

function setLang(val) {
  lang = val;
  localStorage.setItem(LANG_KEY, val);
  document.documentElement.setAttribute('lang', val === 'ru' ? 'ru' : 'en');
  document.getElementById('langRu').classList.toggle('active', val === 'ru');
  document.getElementById('langEn').classList.toggle('active', val === 'en');
  applyLang();
  render();
}

function applyLang() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[lang] && t[lang][key]) el.textContent = t[lang][key];
  });
  document.querySelectorAll('[data-i18n-title]').forEach(el => {
    const key = el.getAttribute('data-i18n-title');
    if (t[lang] && t[lang][key]) { el.title = t[lang][key]; el.setAttribute('aria-label', t[lang][key]); }
  });
  const mt = document.getElementById('modalTitle');
  if (mt) mt.innerHTML = editId ? t[lang].editPosition + ' <span>' + t[lang].position + '</span>' : t[lang].newPosition + ' <span>' + t[lang].position + '</span>';
}

// ‚îÄ‚îÄ‚îÄ Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const STORAGE_KEY = 'defi_positions_v1';

let positions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

// Pre-fill with sample data if empty
if (positions.length === 0) {
  positions = [
    { id: uid(), protocol: 'Avantis',     dateOpen: '2026-01-09', dateClose: '', deposited: 67255, currentValue: 68431, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'Convex',      dateOpen: '2026-01-09', dateClose: '', deposited: 58494, currentValue: 58688, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'Accountable', dateOpen: '2026-01-14', dateClose: '', deposited: 64019, currentValue: 64512, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'GMTrade GM',  dateOpen: '2026-01-30', dateClose: '', deposited: 10000, currentValue: 10037, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'GMTrade GLV', dateOpen: '2026-01-30', dateClose: '', deposited: 10000, currentValue: 10062, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'GMTrade SOL', dateOpen: '2026-01-30', dateClose: '', deposited: 8182,  currentValue: 8271,  withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'StakeDAO',    dateOpen: '2026-02-20', dateClose: '', deposited: 73904, currentValue: 73904, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'Paradex',     dateOpen: '2026-02-20', dateClose: '', deposited: 52451, currentValue: 52451, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'Etherex',     dateOpen: '2026-02-20', dateClose: '', deposited: 59964, currentValue: 59964, withdrawn: 0,    status: 'open',   note: '' },
  ];
  save();
}

let filter = 'all';
let sortField = null;
let sortDir = 1;
let editId = null;

// ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function uid() { return Math.random().toString(36).slice(2, 10); }
function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(positions)); }

function daysBetween(d1, d2) {
  const a = new Date(d1), b = new Date(d2 || new Date().toISOString().slice(0,10));
  return Math.max(0, Math.round((b - a) / 86400000));
}

function toDate(s) {
  if (!s) return '';
  const d = new Date(s);
  return d.toLocaleDateString(lang === 'ru' ? 'ru-RU' : 'en-US');
}

function fmt(n) {
  if (n == null || isNaN(n)) return '‚Äî';
  return Number(n).toLocaleString(lang === 'ru' ? 'ru-RU' : 'en-US', { maximumFractionDigits: 0 });
}

function fmtPct(n) { return (n * 100).toFixed(1) + '%'; }

function calcRow(p) {
  const profit = (p.currentValue + (p.withdrawn || 0)) - p.deposited;
  const returnPct = p.deposited > 0 ? profit / p.deposited : 0;
  const days = daysBetween(p.dateOpen, p.dateClose || '');
  const apy = days > 0 && p.deposited > 0 ? returnPct / days * 365 : null;
  return { profit, returnPct, days, apy };
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function render() {
  let data = [...positions];

  if (filter !== 'all') data = data.filter(p => p.status === filter);

  if (sortField) {
    data.sort((a, b) => {
      let va = sortField === 'profit' || sortField === 'returnPct' || sortField === 'daysOpen'
        ? calcRow(a)[sortField === 'daysOpen' ? 'days' : sortField]
        : (a[sortField] || '');
      let vb = sortField === 'profit' || sortField === 'returnPct' || sortField === 'daysOpen'
        ? calcRow(b)[sortField === 'daysOpen' ? 'days' : sortField]
        : (b[sortField] || '');
      if (typeof va === 'string') return va.localeCompare(vb) * sortDir;
      return (va - vb) * sortDir;
    });
  }

  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  document.getElementById('emptyState').style.display = data.length === 0 ? 'block' : 'none';

  const today = new Date().toISOString().slice(0,10);

  data.forEach((p, idx) => {
    const { profit, returnPct, days, apy } = calcRow(p);
    const profitClass = profit > 0 ? 'profit-pos' : profit < 0 ? 'profit-neg' : 'profit-zero';
    const initial = (p.protocol || '?').charAt(0).toUpperCase();

    let apyStr = '‚Äî', apyClass = 'profit-zero';
    if (apy !== null) {
      apyStr = fmtPct(apy);
      apyClass = apy > 0.15 ? 'apy-very-high' : apy > 0.1 ? 'apy-high' : apy > 0.03 ? 'apy-mid' : 'apy-low';
    }

    const barPct = Math.min(100, Math.abs(returnPct) * 100 / 0.25 * 100).toFixed(1);
    const statusBadge = p.status === 'open'
      ? '<span class="badge-status badge-open">' + (lang === 'ru' ? '–û—Ç–∫—Ä—ã—Ç–∞' : 'Open') + '</span>'
      : '<span class="badge-status badge-closed">' + (lang === 'ru' ? '–ó–∞–∫—Ä—ã—Ç–∞' : 'Closed') + '</span>';

    const tr = document.createElement('tr');
    tr.style.animationDelay = (idx * 0.04) + 's';
    tr.innerHTML = `
      <td class="protocol">
        <span class="protocol-icon">${initial}</span>${p.protocol}
        ${p.note ? `<span style="color:var(--muted2);font-size:10px;display:block;margin-left:38px;margin-top:2px;">${p.note}</span>` : ''}
      </td>
      <td>${toDate(p.dateOpen)}</td>
      <td>${fmt(p.deposited)}</td>
      <td>${days}</td>
      <td>${fmt(p.currentValue)}</td>
      <td>${toDate(today)}</td>
      <td class="${profitClass}">${profit >= 0 ? '+' : ''}${fmt(profit)}</td>
      <td>
        <div class="yield-bar">
          <span class="${profitClass}">${profit >= 0 ? '+' : ''}${fmtPct(returnPct)}</span>
          <div class="yield-track"><div class="yield-fill" style="width:${barPct}%; background:${profit >= 0 ? 'var(--accent)' : 'var(--danger)'}"></div></div>
        </div>
      </td>
      <td class="${apyClass}">${apyStr}</td>
      <td>${statusBadge}</td>
      <td>
        <div class="actions">
          <button class="icon-btn" title="${t[lang].edit}" onclick="editPosition('${p.id}')">‚úèÔ∏è</button>
          <button class="icon-btn del" title="${t[lang].delete}" onclick="deletePosition('${p.id}')">üóë</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  updateStats();
}

function updateStats() {
  const open = positions.filter(p => p.status === 'open');
  const closed = positions.filter(p => p.status === 'closed');

  const totalDep = positions.reduce((s, p) => s + (p.deposited || 0), 0);
  const totalProfit = positions.reduce((s, p) => { const r = calcRow(p); return s + r.profit; }, 0);
  const totalYield = totalDep > 0 ? totalProfit / totalDep : 0;

  const openReturns = open.map(p => calcRow(p).returnPct).filter(r => !isNaN(r));
  const avgYield = openReturns.length ? openReturns.reduce((a,b) => a+b, 0) / openReturns.length : 0;

  let best = null, bestReturn = -Infinity;
  positions.forEach(p => {
    const r = calcRow(p).returnPct;
    if (r > bestReturn) { bestReturn = r; best = p.protocol; }
  });

  document.getElementById('totalDeposit').textContent = fmt(totalDep);
  const profitEl = document.getElementById('totalProfit');
  profitEl.textContent = (totalProfit >= 0 ? '+' : '') + fmt(totalProfit);
  profitEl.style.color = totalProfit >= 0 ? 'var(--accent)' : 'var(--danger)';

  const totalYieldEl = document.getElementById('totalYield');
  totalYieldEl.textContent = (totalYield >= 0 ? '+' : '') + fmtPct(totalYield);
  const yieldTier = totalYield < 0 ? 'yield-danger' : totalYield > 0.15 ? 'yield-dark-green' : totalYield > 0.1 ? 'yield-green' : totalYield > 0.03 ? 'yield-yellow' : 'yield-gray';
  totalYieldEl.className = 'value ' + yieldTier;
  document.getElementById('openCount').textContent = open.length;
  document.getElementById('closedCount').textContent = closed.length;
  const avgEl = document.getElementById('avgYield');
  avgEl.textContent = (avgYield >= 0 ? '+' : '') + fmtPct(avgYield);
  avgEl.className = 'c-value ' + (avgYield > 0.15 ? 'dark-green' : avgYield > 0.1 ? 'green' : avgYield > 0.03 ? 'yellow' : 'gray');
  document.getElementById('bestProtocol').textContent = best || '‚Äî';
}

// ‚îÄ‚îÄ‚îÄ Sort & Filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function setFilter(f, el) {
  filter = f;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  render();
}

function sortBy(field) {
  if (sortField === field) sortDir *= -1;
  else { sortField = field; sortDir = -1; }
  document.querySelectorAll('thead th').forEach(th => th.classList.remove('sorted'));
  event.currentTarget.classList.add('sorted');
  render();
}

// ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openModal(id) {
  editId = id || null;
  document.getElementById('modalTitle').innerHTML = editId
    ? t[lang].editPosition + ' <span>' + t[lang].position + '</span>'
    : t[lang].newPosition + ' <span>' + t[lang].position + '</span>';

  if (editId) {
    const p = positions.find(x => x.id === editId);
    if (p) {
      document.getElementById('f_protocol').value = p.protocol || '';
      document.getElementById('f_dateOpen').value = p.dateOpen || '';
      document.getElementById('f_dateClose').value = p.dateClose || '';
      document.getElementById('f_deposited').value = p.deposited || '';
      document.getElementById('f_currentValue').value = p.currentValue || '';
      document.getElementById('f_withdrawn').value = p.withdrawn || '';
      document.getElementById('f_status').value = p.status || 'open';
      document.getElementById('f_note').value = p.note || '';
    }
  } else {
    document.getElementById('f_protocol').value = '';
    document.getElementById('f_dateOpen').value = new Date().toISOString().slice(0,10);
    document.getElementById('f_dateClose').value = '';
    document.getElementById('f_deposited').value = '';
    document.getElementById('f_currentValue').value = '';
    document.getElementById('f_withdrawn').value = '';
    document.getElementById('f_status').value = 'open';
    document.getElementById('f_note').value = '';
  }

  document.getElementById('modalBackdrop').classList.add('open');
}

function editPosition(id) { openModal(id); }

function closeModal() {
  document.getElementById('modalBackdrop').classList.remove('open');
}

function closeModalOutside(e) {
  if (e.target === document.getElementById('modalBackdrop')) closeModal();
}

function savePosition() {
  const protocol = document.getElementById('f_protocol').value.trim();
  if (!protocol) { alert(t[lang].enterProtocol); return; }

  const entry = {
    id: editId || uid(),
    protocol,
    dateOpen:     document.getElementById('f_dateOpen').value,
    dateClose:    document.getElementById('f_dateClose').value,
    deposited:    parseFloat(document.getElementById('f_deposited').value) || 0,
    currentValue: parseFloat(document.getElementById('f_currentValue').value) || 0,
    withdrawn:    parseFloat(document.getElementById('f_withdrawn').value) || 0,
    status:       document.getElementById('f_status').value,
    note:         document.getElementById('f_note').value.trim(),
  };

  if (editId) {
    const idx = positions.findIndex(x => x.id === editId);
    if (idx >= 0) positions[idx] = entry;
  } else {
    positions.push(entry);
  }

  save();
  closeModal();
  render();
}

function deletePosition(id) {
  if (!confirm(t[lang].deleteConfirm)) return;
  positions = positions.filter(x => x.id !== id);
  save();
  render();
}

// ‚îÄ‚îÄ‚îÄ DeBank ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadFromDebank() {
  const addr = document.getElementById('debankAddr').value.trim();
  const resultEl = document.getElementById('debankResult');

  if (!addr || !/^0x[a-fA-F0-9]{40}$/.test(addr)) {
    resultEl.style.display = 'block';
    resultEl.className = 'debank-result error';
    resultEl.textContent = lang === 'ru' ? '–í–≤–µ–¥–∏—Ç–µ –≤–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å (0x + 40 —Å–∏–º–≤–æ–ª–æ–≤)' : 'Enter valid address (0x + 40 chars)';
    return;
  }

  resultEl.style.display = 'block';
  resultEl.className = 'debank-result loading';
  resultEl.textContent = t[lang].debankLoading;

  try {
    const base = window.location.origin;
    const res = await fetch(`${base}/api/debank/wallet?addr=${encodeURIComponent(addr)}`);
    const data = await res.json();

    if (!res.ok) {
      resultEl.className = 'debank-result error';
      resultEl.innerHTML = (data.error || data.message || 'Error') + (data.detail ? ': ' + data.detail : '');
      return;
    }

    const total = data.total_usd_value != null ? data.total_usd_value : 0;
    const fmt = (n) => Number(n).toLocaleString(lang === 'ru' ? 'ru-RU' : 'en-US', { maximumFractionDigits: 2 });

    let html = '<div class="total">' + t[lang].debankTotal + ': $' + fmt(total) + '</div>';
    if (data.chain_list && data.chain_list.length > 0) {
      const chains = data.chain_list.filter(c => c.usd_value > 0).slice(0, 5);
      if (chains.length) {
        html += '<div style="margin-top:8px;color:var(--muted2);font-size:11px;">' +
          chains.map(c => c.name + ': $' + fmt(c.usd_value)).join(' ¬∑ ') + '</div>';
      }
    }
    resultEl.className = 'debank-result';
    resultEl.innerHTML = html;
  } catch (err) {
    resultEl.className = 'debank-result error';
    resultEl.textContent = t[lang].debankError + ': ' + err.message;
  }
}

// ‚îÄ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function exportCSV() {
  const cols = [t[lang].protocol, t[lang].dateOpen, t[lang].dateClose, t[lang].deposited, t[lang].currentValue, t[lang].withdrawn, t[lang].profit, t[lang].yield + ' %', t[lang].daysInPosition, t[lang].status, t[lang].note];
  const rows = [cols.join(';')];

  positions.forEach(p => {
    const { profit, returnPct, days } = calcRow(p);
    rows.push([
      p.protocol,
      p.dateOpen,
      p.dateClose || '',
      p.deposited,
      p.currentValue,
      p.withdrawn || 0,
      profit.toFixed(2),
      (returnPct * 100).toFixed(2),
      days,
      p.status,
      p.note || '',
    ].join(';'));
  });

  const blob = new Blob(['\uFEFF' + rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'defi_positions.csv'; a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.documentElement.setAttribute('data-theme', theme);
document.documentElement.setAttribute('lang', lang === 'ru' ? 'ru' : 'en');
document.getElementById('themeDark').classList.toggle('active', theme === 'dark');
document.getElementById('themeLight').classList.toggle('active', theme === 'light');
document.getElementById('langRu').classList.toggle('active', lang === 'ru');
document.getElementById('langEn').classList.toggle('active', lang === 'en');
applyLang();
render();

// ‚îÄ‚îÄ‚îÄ Chat Widget ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Option A: Tawk.to (free live chat). Sign up at https://www.tawk.to ‚Üí replace IDs below.
// When configured, Tawk.to adds its own bubble; we hide our button.
// Option B: Edit the chat button href above to your Telegram/Discord or remove id to hide.
(function() {
  var TAWK_PROPERTY_ID = 'YOUR_PROPERTY_ID';
  var TAWK_WIDGET_ID = 'YOUR_WIDGET_ID';
  if (TAWK_PROPERTY_ID === 'YOUR_PROPERTY_ID') return;
  var btn = document.getElementById('chatWidgetBtn');
  if (btn) btn.style.display = 'none';
  var s1 = document.createElement('script'), s2 = document.getElementsByTagName('script')[0];
  s1.async = true;
  s1.src = 'https://embed.tawk.to/' + TAWK_PROPERTY_ID + '/' + TAWK_WIDGET_ID;
  s2.parentNode.insertBefore(s1, s2);
})();
</script>
</body>
</html>
