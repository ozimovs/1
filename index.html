<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeFi Stable</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0d12;
    --surface: #111520;
    --surface2: #181e2e;
    --border: #1e2a40;
    --accent: #00e5a0;
    --accent-dark: #00b378;
    --accent2: #3b82f6;
    --warn: #f59e0b;
    --danger: #ef4444;
    --text: #e2e8f0;
    --muted: #4a5568;
    --muted2: #718096;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    padding: 24px;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
  }

  .wrapper { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; }

  /* Header */
  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .logo-block h1 {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .logo-block h1 span { color: var(--accent); }

  .logo-block p {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--muted2);
    margin-top: 4px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .header-stats {
    display: flex;
    gap: 32px;
    align-items: flex-end;
  }

  .stat-pill {
    text-align: right;
  }

  .stat-pill .label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--muted2);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stat-pill .value {
    font-size: 22px;
    font-weight: 800;
    color: var(--accent);
    font-family: 'Space Mono', monospace;
  }

  .stat-pill .value.neutral { color: var(--text); }

  /* Action bar */
  .action-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.3px;
  }

  .btn-primary {
    background: var(--accent);
    color: #0a0d12;
  }

  .btn-primary:hover { background: #00ffb2; transform: translateY(-1px); }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  .btn-danger {
    background: transparent;
    color: var(--danger);
    border: 1px solid var(--danger);
  }

  .btn-danger:hover { background: var(--danger); color: white; }

  /* Filter tabs */
  .filter-tabs {
    display: flex;
    gap: 4px;
    margin-left: auto;
    background: var(--surface);
    padding: 4px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  .tab {
    padding: 6px 16px;
    border-radius: 5px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    color: var(--muted2);
    transition: all 0.15s;
    font-family: 'Space Mono', monospace;
  }

  .tab.active {
    background: var(--accent);
    color: #0a0d12;
  }

  .tab:not(.active):hover { color: var(--text); }

  /* Table */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead tr {
    background: var(--surface2);
    border-bottom: 2px solid var(--border);
  }

  thead th {
    padding: 14px 16px;
    text-align: left;
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted2);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.15s;
  }

  thead th:hover { color: var(--accent); }

  thead th .sort-icon { opacity: 0.4; margin-left: 4px; }
  thead th.sorted .sort-icon { opacity: 1; color: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
    animation: rowIn 0.3s ease forwards;
    opacity: 0;
  }

  @keyframes rowIn {
    from { opacity: 0; transform: translateX(-8px); }
    to { opacity: 1; transform: translateX(0); }
  }

  tbody tr:hover { background: rgba(0, 229, 160, 0.04); }
  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 14px 16px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    vertical-align: middle;
  }

  td.protocol {
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
  }

  .protocol-icon {
    display: inline-flex;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 800;
    margin-right: 10px;
    vertical-align: middle;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--accent);
  }

  .badge-status {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-open { background: rgba(0, 229, 160, 0.1); color: var(--accent); border: 1px solid rgba(0, 229, 160, 0.3); }
  .badge-closed { background: rgba(100, 116, 139, 0.15); color: var(--muted2); border: 1px solid var(--border); }

  .yield-bar {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .yield-track {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    min-width: 60px;
    overflow: hidden;
  }

  .yield-fill {
    height: 100%;
    border-radius: 2px;
    background: var(--accent);
    transition: width 0.6s ease;
  }

  .profit-pos { color: var(--accent); }
  .profit-neg { color: var(--danger); }
  .profit-zero { color: var(--muted2); }

  .apy-very-high { color: var(--accent-dark); font-weight: 700; }
  .apy-high { color: var(--accent); font-weight: 700; }
  .apy-mid { color: var(--warn); }
  .apy-low { color: var(--muted2); }

  td .actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.15s; }
  tr:hover td .actions { opacity: 1; }

  .icon-btn {
    width: 28px; height: 28px;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted2);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    transition: all 0.15s;
  }

  .icon-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,229,160,0.05); }
  .icon-btn.del:hover { border-color: var(--danger); color: var(--danger); background: rgba(239,68,68,0.05); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted2);
  }

  .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }
  .empty-state p { font-family: 'Space Mono', monospace; font-size: 12px; }

  /* Modal */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 100;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .modal-backdrop.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 24px 64px rgba(0,0,0,0.5);
    animation: modalIn 0.2s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal h2 {
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 24px;
    color: var(--text);
  }

  .modal h2 span { color: var(--accent); }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-group.full { grid-column: 1 / -1; }

  label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted2);
  }

  input, select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 12px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    transition: border-color 0.15s;
    outline: none;
  }

  input:focus, select:focus { border-color: var(--accent); }

  select option { background: var(--surface2); }

  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 24px;
    justify-content: flex-end;
  }

  /* Summary cards */
  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), transparent);
  }

  .card:hover { border-color: rgba(0, 229, 160, 0.3); }

  .card .c-label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted2);
    margin-bottom: 8px;
  }

  .card .c-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--text);
    font-family: 'Space Mono', monospace;
  }

  .card .c-value.dark-green { color: var(--accent-dark); }
  .card .c-value.green { color: var(--accent); }
  .card .c-value.yellow { color: var(--warn); }
  .card .c-value.gray { color: var(--muted2); }

  /* Export button animation */
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(0,229,160,0.4); }
    50% { box-shadow: 0 0 0 6px rgba(0,229,160,0); }
  }

  .pulse { animation: pulse 2s infinite; }

  /* Responsive */
  @media (max-width: 900px) {
    .form-grid { grid-template-columns: 1fr; }
    .form-group.full { grid-column: 1; }
    header { flex-direction: column; gap: 20px; align-items: flex-start; }
    .header-stats { justify-content: flex-start; }
  }
</style>
</head>
<body>
<div class="wrapper">

  <header>
    <div class="logo-block">
      <h1>DeFi <span>Stable</span></h1>
      <p>–£—á—ë—Ç –ø–æ–∑–∏—Ü–∏–π ¬∑ Yield Tracker</p>
    </div>
    <div class="header-stats">
      <div class="stat-pill">
        <div class="label">–í—Å–µ–≥–æ –≤–ª–æ–∂–µ–Ω–æ</div>
        <div class="value neutral" id="totalDeposit">‚Äî</div>
      </div>
      <div class="stat-pill">
        <div class="label">–ü—Ä–∏–±—ã–ª—å</div>
        <div class="value" id="totalProfit">‚Äî</div>
      </div>
      <div class="stat-pill">
        <div class="label">–¢–µ–∫—É—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
        <div class="value" id="totalYield">‚Äî</div>
      </div>
    </div>
  </header>

  <div class="summary-cards">
    <div class="card">
      <div class="c-label">–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</div>
      <div class="c-value green" id="openCount">0</div>
    </div>
    <div class="card">
      <div class="c-label">–ó–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</div>
      <div class="c-value" id="closedCount">0</div>
    </div>
    <div class="card">
      <div class="c-label">–°—Ä–µ–¥–Ω—è—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
      <div class="c-value" id="avgYield">0.00%</div>
    </div>
    <div class="card">
      <div class="c-label">–õ—É—á—à–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª</div>
      <div class="c-value green" id="bestProtocol" style="font-size:16px;">‚Äî</div>
    </div>
  </div>

  <div class="action-bar">
    <button class="btn btn-primary pulse" onclick="openModal()">Ôºã –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
    <button class="btn btn-secondary" onclick="exportCSV()">‚¨á –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <div class="filter-tabs">
      <div class="tab active" onclick="setFilter('all', this)">ALL</div>
      <div class="tab" onclick="setFilter('open', this)">OPEN</div>
      <div class="tab" onclick="setFilter('closed', this)">CLOSED</div>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('protocol')">–ü—Ä–æ—Ç–æ–∫–æ–ª <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('dateOpen')">–î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('deposited')">–°—É–º–º–∞ –≤–Ω–µ—Å–µ–Ω–∞ <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('daysOpen')">–î–Ω–µ–π –≤ –ø–æ–∑–∏—Ü–∏–∏ <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('currentValue')">–¢–µ–∫. —Å—Ç–æ–∏–º–æ—Å—Ç—å <span class="sort-icon">‚Üï</span></th>
          <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
          <th onclick="sortBy('profit')">–ü—Ä–∏–±—ã–ª—å <span class="sort-icon">‚Üï</span></th>
          <th onclick="sortBy('returnPct')">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å <span class="sort-icon">‚Üï</span></th>
          <th>APY (–æ—Ü–µ–Ω–∫–∞)</th>
          <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="icon">üìä</div>
      <p>–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>
    </div>
  </div>

</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop" onclick="closeModalOutside(event)">
  <div class="modal">
    <h2 id="modalTitle">–ù–æ–≤–∞—è <span>–ø–æ–∑–∏—Ü–∏—è</span></h2>
    <div class="form-grid">
      <div class="form-group full">
        <label>–ü—Ä–æ—Ç–æ–∫–æ–ª / DeFi-–ø—Ä–æ—Ç–æ–∫–æ–ª</label>
        <input type="text" id="f_protocol" placeholder="Avantis, Convex...">
      </div>
      <div class="form-group">
        <label>–î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è</label>
        <input type="date" id="f_dateOpen">
      </div>
      <div class="form-group">
        <label>–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</label>
        <input type="date" id="f_dateClose" placeholder="–ï—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç–∞">
      </div>
      <div class="form-group">
        <label>–°—É–º–º–∞ –≤–Ω–µ—Å–µ–Ω–∞</label>
        <input type="number" id="f_deposited" placeholder="0">
      </div>
      <div class="form-group">
        <label>–¢–µ–∫. —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
        <input type="number" id="f_currentValue" placeholder="0">
      </div>
      <div class="form-group">
        <label>–í—ã–≤–µ–¥–µ–Ω–æ</label>
        <input type="number" id="f_withdrawn" placeholder="0">
      </div>
      <div class="form-group">
        <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
        <select id="f_status">
          <option value="open">Open</option>
          <option value="closed">Closed</option>
        </select>
      </div>
      <div class="form-group">
        <label>–ó–∞–º–µ—Ç–∫–∞</label>
        <input type="text" id="f_note" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="savePosition()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const STORAGE_KEY = 'defi_positions_v1';

let positions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

// Pre-fill with sample data if empty
if (positions.length === 0) {
  positions = [
    { id: uid(), protocol: 'Avantis',     dateOpen: '2026-01-09', dateClose: '', deposited: 67255, currentValue: 68431, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'Convex',      dateOpen: '2026-01-09', dateClose: '', deposited: 58494, currentValue: 58688, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'Accountable', dateOpen: '2026-01-14', dateClose: '', deposited: 64019, currentValue: 64512, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'GMTrade GM',  dateOpen: '2026-01-30', dateClose: '', deposited: 10000, currentValue: 10037, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'GMTrade GLV', dateOpen: '2026-01-30', dateClose: '', deposited: 10000, currentValue: 10062, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'GMTrade SOL', dateOpen: '2026-01-30', dateClose: '', deposited: 8182,  currentValue: 8271,  withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'StakeDAO',    dateOpen: '2026-02-20', dateClose: '', deposited: 73904, currentValue: 73904, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'Paradex',     dateOpen: '2026-02-20', dateClose: '', deposited: 52451, currentValue: 52451, withdrawn: 0,    status: 'open',   note: '' },
    { id: uid(), protocol: 'Etherex',     dateOpen: '2026-02-20', dateClose: '', deposited: 59964, currentValue: 59964, withdrawn: 0,    status: 'open',   note: '' },
  ];
  save();
}

let filter = 'all';
let sortField = null;
let sortDir = 1;
let editId = null;

// ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function uid() { return Math.random().toString(36).slice(2, 10); }
function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(positions)); }

function daysBetween(d1, d2) {
  const a = new Date(d1), b = new Date(d2 || new Date().toISOString().slice(0,10));
  return Math.max(0, Math.round((b - a) / 86400000));
}

function toDate(s) {
  if (!s) return '';
  const d = new Date(s);
  return d.toLocaleDateString('ru-RU');
}

function fmt(n) {
  if (n == null || isNaN(n)) return '‚Äî';
  return Number(n).toLocaleString('ru-RU', { maximumFractionDigits: 0 });
}

function fmtPct(n) { return (n * 100).toFixed(1) + '%'; }

function calcRow(p) {
  const profit = (p.currentValue + (p.withdrawn || 0)) - p.deposited;
  const returnPct = p.deposited > 0 ? profit / p.deposited : 0;
  const days = daysBetween(p.dateOpen, p.dateClose || '');
  const apy = days > 0 && p.deposited > 0 ? returnPct / days * 365 : null;
  return { profit, returnPct, days, apy };
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function render() {
  let data = [...positions];

  if (filter !== 'all') data = data.filter(p => p.status === filter);

  if (sortField) {
    data.sort((a, b) => {
      let va = sortField === 'profit' || sortField === 'returnPct' || sortField === 'daysOpen'
        ? calcRow(a)[sortField === 'daysOpen' ? 'days' : sortField]
        : (a[sortField] || '');
      let vb = sortField === 'profit' || sortField === 'returnPct' || sortField === 'daysOpen'
        ? calcRow(b)[sortField === 'daysOpen' ? 'days' : sortField]
        : (b[sortField] || '');
      if (typeof va === 'string') return va.localeCompare(vb) * sortDir;
      return (va - vb) * sortDir;
    });
  }

  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  document.getElementById('emptyState').style.display = data.length === 0 ? 'block' : 'none';

  const today = new Date().toISOString().slice(0,10);

  data.forEach((p, idx) => {
    const { profit, returnPct, days, apy } = calcRow(p);
    const profitClass = profit > 0 ? 'profit-pos' : profit < 0 ? 'profit-neg' : 'profit-zero';
    const initial = (p.protocol || '?').charAt(0).toUpperCase();

    let apyStr = '‚Äî', apyClass = 'profit-zero';
    if (apy !== null) {
      apyStr = fmtPct(apy);
      apyClass = apy > 0.15 ? 'apy-very-high' : apy > 0.1 ? 'apy-high' : apy > 0.03 ? 'apy-mid' : 'apy-low';
    }

    const barPct = Math.min(100, Math.abs(returnPct) * 100 / 0.25 * 100).toFixed(1);
    const statusBadge = p.status === 'open'
      ? '<span class="badge-status badge-open">Open</span>'
      : '<span class="badge-status badge-closed">Closed</span>';

    const tr = document.createElement('tr');
    tr.style.animationDelay = (idx * 0.04) + 's';
    tr.innerHTML = `
      <td class="protocol">
        <span class="protocol-icon">${initial}</span>${p.protocol}
        ${p.note ? `<span style="color:var(--muted2);font-size:10px;display:block;margin-left:38px;margin-top:2px;">${p.note}</span>` : ''}
      </td>
      <td>${toDate(p.dateOpen)}</td>
      <td>${fmt(p.deposited)}</td>
      <td>${days}</td>
      <td>${fmt(p.currentValue)}</td>
      <td>${toDate(today)}</td>
      <td class="${profitClass}">${profit >= 0 ? '+' : ''}${fmt(profit)}</td>
      <td>
        <div class="yield-bar">
          <span class="${profitClass}">${profit >= 0 ? '+' : ''}${fmtPct(returnPct)}</span>
          <div class="yield-track"><div class="yield-fill" style="width:${barPct}%; background:${profit >= 0 ? 'var(--accent)' : 'var(--danger)'}"></div></div>
        </div>
      </td>
      <td class="${apyClass}">${apyStr}</td>
      <td>${statusBadge}</td>
      <td>
        <div class="actions">
          <button class="icon-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="editPosition('${p.id}')">‚úèÔ∏è</button>
          <button class="icon-btn del" title="–£–¥–∞–ª–∏—Ç—å" onclick="deletePosition('${p.id}')">üóë</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  updateStats();
}

function updateStats() {
  const open = positions.filter(p => p.status === 'open');
  const closed = positions.filter(p => p.status === 'closed');

  const totalDep = positions.reduce((s, p) => s + (p.deposited || 0), 0);
  const totalProfit = positions.reduce((s, p) => { const r = calcRow(p); return s + r.profit; }, 0);
  const totalYield = totalDep > 0 ? totalProfit / totalDep : 0;

  const openReturns = open.map(p => calcRow(p).returnPct).filter(r => !isNaN(r));
  const avgYield = openReturns.length ? openReturns.reduce((a,b) => a+b, 0) / openReturns.length : 0;

  let best = null, bestReturn = -Infinity;
  positions.forEach(p => {
    const r = calcRow(p).returnPct;
    if (r > bestReturn) { bestReturn = r; best = p.protocol; }
  });

  document.getElementById('totalDeposit').textContent = fmt(totalDep);
  const profitEl = document.getElementById('totalProfit');
  profitEl.textContent = (totalProfit >= 0 ? '+' : '') + fmt(totalProfit);
  profitEl.style.color = totalProfit >= 0 ? 'var(--accent)' : 'var(--danger)';

  const totalYieldEl = document.getElementById('totalYield');
  totalYieldEl.textContent = (totalYield >= 0 ? '+' : '') + fmtPct(totalYield);
  totalYieldEl.style.color = totalYield < 0 ? 'var(--danger)' : totalYield > 0.15 ? 'var(--accent-dark)' : totalYield > 0.1 ? 'var(--accent)' : totalYield > 0.03 ? 'var(--warn)' : 'var(--muted2)';
  document.getElementById('openCount').textContent = open.length;
  document.getElementById('closedCount').textContent = closed.length;
  const avgEl = document.getElementById('avgYield');
  avgEl.textContent = (avgYield >= 0 ? '+' : '') + fmtPct(avgYield);
  avgEl.className = 'c-value ' + (avgYield > 0.15 ? 'dark-green' : avgYield > 0.1 ? 'green' : avgYield > 0.03 ? 'yellow' : 'gray');
  document.getElementById('bestProtocol').textContent = best || '‚Äî';
}

// ‚îÄ‚îÄ‚îÄ Sort & Filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function setFilter(f, el) {
  filter = f;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  render();
}

function sortBy(field) {
  if (sortField === field) sortDir *= -1;
  else { sortField = field; sortDir = -1; }
  document.querySelectorAll('thead th').forEach(th => th.classList.remove('sorted'));
  event.currentTarget.classList.add('sorted');
  render();
}

// ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openModal(id) {
  editId = id || null;
  document.getElementById('modalTitle').innerHTML = editId
    ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å <span>–ø–æ–∑–∏—Ü–∏—é</span>'
    : '–ù–æ–≤–∞—è <span>–ø–æ–∑–∏—Ü–∏—è</span>';

  if (editId) {
    const p = positions.find(x => x.id === editId);
    if (p) {
      document.getElementById('f_protocol').value = p.protocol || '';
      document.getElementById('f_dateOpen').value = p.dateOpen || '';
      document.getElementById('f_dateClose').value = p.dateClose || '';
      document.getElementById('f_deposited').value = p.deposited || '';
      document.getElementById('f_currentValue').value = p.currentValue || '';
      document.getElementById('f_withdrawn').value = p.withdrawn || '';
      document.getElementById('f_status').value = p.status || 'open';
      document.getElementById('f_note').value = p.note || '';
    }
  } else {
    document.getElementById('f_protocol').value = '';
    document.getElementById('f_dateOpen').value = new Date().toISOString().slice(0,10);
    document.getElementById('f_dateClose').value = '';
    document.getElementById('f_deposited').value = '';
    document.getElementById('f_currentValue').value = '';
    document.getElementById('f_withdrawn').value = '';
    document.getElementById('f_status').value = 'open';
    document.getElementById('f_note').value = '';
  }

  document.getElementById('modalBackdrop').classList.add('open');
}

function editPosition(id) { openModal(id); }

function closeModal() {
  document.getElementById('modalBackdrop').classList.remove('open');
}

function closeModalOutside(e) {
  if (e.target === document.getElementById('modalBackdrop')) closeModal();
}

function savePosition() {
  const protocol = document.getElementById('f_protocol').value.trim();
  if (!protocol) { alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ–∫–æ–ª'); return; }

  const entry = {
    id: editId || uid(),
    protocol,
    dateOpen:     document.getElementById('f_dateOpen').value,
    dateClose:    document.getElementById('f_dateClose').value,
    deposited:    parseFloat(document.getElementById('f_deposited').value) || 0,
    currentValue: parseFloat(document.getElementById('f_currentValue').value) || 0,
    withdrawn:    parseFloat(document.getElementById('f_withdrawn').value) || 0,
    status:       document.getElementById('f_status').value,
    note:         document.getElementById('f_note').value.trim(),
  };

  if (editId) {
    const idx = positions.findIndex(x => x.id === editId);
    if (idx >= 0) positions[idx] = entry;
  } else {
    positions.push(entry);
  }

  save();
  closeModal();
  render();
}

function deletePosition(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é?')) return;
  positions = positions.filter(x => x.id !== id);
  save();
  render();
}

// ‚îÄ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function exportCSV() {
  const cols = ['–ü—Ä–æ—Ç–æ–∫–æ–ª','–î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è','–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è','–°—É–º–º–∞ –≤–Ω–µ—Å–µ–Ω–∞','–¢–µ–∫. —Å—Ç–æ–∏–º–æ—Å—Ç—å','–í—ã–≤–µ–¥–µ–Ω–æ','–ü—Ä–∏–±—ã–ª—å','–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å %','–î–Ω–µ–π –≤ –ø–æ–∑–∏—Ü–∏–∏','–°–æ—Å—Ç–æ—è–Ω–∏–µ','–ó–∞–º–µ—Ç–∫–∞'];
  const rows = [cols.join(';')];

  positions.forEach(p => {
    const { profit, returnPct, days } = calcRow(p);
    rows.push([
      p.protocol,
      p.dateOpen,
      p.dateClose || '',
      p.deposited,
      p.currentValue,
      p.withdrawn || 0,
      profit.toFixed(2),
      (returnPct * 100).toFixed(2),
      days,
      p.status,
      p.note || '',
    ].join(';'));
  });

  const blob = new Blob(['\uFEFF' + rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'defi_positions.csv'; a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
render();
</script>
</body>
</html>
