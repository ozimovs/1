<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeBank ‚Äî –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤—ã | DeFi Stable</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root, [data-theme="dark"] {
    --bg: #0a0d12; --surface: #111520; --surface2: #181e2e; --border: #1e2a40;
    --accent: #00e5a0; --accent-dark: #008c5a; --warn: #f59e0b; --danger: #ef4444;
    --text: #e2e8f0; --muted: #4a5568; --muted2: #718096; --btn-primary-text: #0a0d12;
  }
  [data-theme="light"] {
    --bg: #f1f5f9; --surface: #ffffff; --surface2: #e2e8f0; --border: #cbd5e1;
    --accent: #059669; --accent-dark: #047857; --warn: #d97706; --danger: #dc2626;
    --text: #1e293b; --muted: #64748b; --muted2: #94a3b8; --btn-primary-text: #ffffff;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif;
    min-height: 100vh; padding: 24px; transition: background 0.3s, color 0.3s;
  }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0; opacity: 0.4;
  }
  [data-theme="light"] body::before { opacity: 0.15; }
  .wrapper { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; }
  header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--border);
  }
  .logo-block a { text-decoration: none; color: inherit; }
  .logo-block h1 { font-size: 24px; font-weight: 800; }
  .logo-block h1 span { color: var(--accent); }
  .logo-block p { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted2); margin-top: 4px; text-transform: uppercase; }
  .btn {
    padding: 10px 20px; border: none; border-radius: 6px; font-family: 'Syne', sans-serif;
    font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.15s;
  }
  .btn-primary { background: var(--accent); color: var(--btn-primary-text); }
  .btn-primary:hover { background: #00ffb2; transform: translateY(-1px); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .search-box {
    display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;
    margin-bottom: 32px; padding: 24px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 12px;
  }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group label { font-family: 'Space Mono', monospace; font-size: 10px; text-transform: uppercase; color: var(--muted2); }
  .form-group input {
    width: 420px; max-width: 100%;
    background: var(--surface2); border: 1px solid var(--border); border-radius: 6px;
    padding: 12px 16px; color: var(--text); font-family: 'Space Mono', monospace; font-size: 13px;
  }
  .form-group input:focus { outline: none; border-color: var(--accent); }
  .summary-cards {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px; margin-bottom: 24px;
  }
  .card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 20px; position: relative; overflow: hidden;
  }
  .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--accent), transparent); }
  .card .c-label { font-family: 'Space Mono', monospace; font-size: 10px; text-transform: uppercase; color: var(--muted2); margin-bottom: 8px; }
  .card .c-value { font-size: 24px; font-weight: 800; font-family: 'Space Mono', monospace; color: var(--accent); }
  .table-wrap {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
  }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead tr { background: var(--surface2); border-bottom: 2px solid var(--border); }
  thead th {
    padding: 14px 16px; text-align: left; font-family: 'Space Mono', monospace;
    font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted2);
  }
  tbody tr { border-bottom: 1px solid var(--border); }
  tbody tr:hover { background: rgba(0, 229, 160, 0.04); }
  td { padding: 12px 16px; font-family: 'Space Mono', monospace; font-size: 12px; }
  .token-cell { display: flex; align-items: center; gap: 10px; }
  .token-cell img { width: 24px; height: 24px; border-radius: 50%; }
  .token-cell .symbol { font-weight: 700; color: var(--text); }
  .token-cell .name { font-size: 10px; color: var(--muted2); }
  .usd-value { color: var(--accent); font-weight: 600; }
  .loading { text-align: center; padding: 48px; color: var(--muted2); }
  .error { color: var(--danger); padding: 16px; }
  .empty { text-align: center; padding: 48px; color: var(--muted2); }
  .toggle-group { display: flex; gap: 8px; align-items: center; }
  .toggle-btn {
    padding: 6px 12px; border: none; border-radius: 6px; background: transparent;
    color: var(--muted2); font-size: 12px; font-weight: 600; cursor: pointer;
    font-family: 'Space Mono', monospace; transition: all 0.15s;
  }
  .toggle-btn:hover { color: var(--text); }
  .toggle-btn.active { background: var(--accent); color: var(--btn-primary-text); }
</style>
</head>
<body>
<div class="wrapper">
  <header>
    <div class="logo-block">
      <a href="index.html">
        <h1>DeFi <span>Stable</span></h1>
        <p>DeBank ¬∑ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤—ã</p>
      </a>
    </div>
    <div class="toggle-group">
      <button class="toggle-btn active" id="themeDark" onclick="setTheme('dark')">üåô</button>
      <button class="toggle-btn" id="themeLight" onclick="setTheme('light')">‚òÄÔ∏è</button>
      <button class="toggle-btn active" id="langRu" onclick="setLang('ru')">RU</button>
      <button class="toggle-btn" id="langEn" onclick="setLang('en')">EN</button>
      <a href="index.html" class="btn btn-secondary">‚Üê –¢—Ä–µ–∫–µ—Ä</a>
    </div>
  </header>

  <div class="search-box">
    <div class="form-group">
      <label id="lblAddr">–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞</label>
      <input type="text" id="addr" placeholder="0x...">
    </div>
    <button class="btn btn-primary" onclick="loadAssets()" id="btnLoad">üì° –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤—ã</button>
    <p style="font-size:11px; color:var(--muted2); margin-top:12px; margin-bottom:0;" id="apiHint">–ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏: –æ—Ç–∫—Ä–æ–π—Ç–µ debank.html?api=https://–≤–∞—à-vercel.vercel.app</p>
  </div>

  <div class="summary-cards" id="summaryCards" style="display:none;">
    <div class="card">
      <div class="c-label" id="lblTotal">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
      <div class="c-value" id="totalValue">$0</div>
    </div>
    <div class="card">
      <div class="c-label" id="lblChains">–°–µ—Ç–µ–π</div>
      <div class="c-value" id="chainCount">0</div>
    </div>
    <div class="card">
      <div class="c-label" id="lblTokens">–¢–æ–∫–µ–Ω–æ–≤</div>
      <div class="c-value" id="tokenCount">0</div>
    </div>
  </div>

  <div class="table-wrap" id="tableWrap" style="display:none;">
    <table>
      <thead>
        <tr>
          <th id="thToken">–¢–æ–∫–µ–Ω</th>
          <th id="thChain">–°–µ—Ç—å</th>
          <th id="thAmount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
          <th id="thUsd">USD</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  <div class="loading" id="loading" style="display:none;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div class="empty" id="empty" style="display:none;">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª</div>
  <div class="error" id="error" style="display:none;"></div>
</div>

<script>
// URL API –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ —Å GitHub Pages
const VERCEL_API = 'https://1-nine-sable-41.vercel.app';
const LANG_KEY = 'defi_lang'; const THEME_KEY = 'defi_theme';
const t = {
  ru: {
    lblAddr: '–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞', btnLoad: 'üì° –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤—ã', lblTotal: '–û–±—â–∏–π –±–∞–ª–∞–Ω—Å',
    lblChains: '–°–µ—Ç–µ–π', lblTokens: '–¢–æ–∫–µ–Ω–æ–≤', thToken: '–¢–æ–∫–µ–Ω', thChain: '–°–µ—Ç—å', thAmount: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', thUsd: 'USD',
    loading: '–ó–∞–≥—Ä—É–∑–∫–∞...', empty: '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª', back: '‚Üê –¢—Ä–µ–∫–µ—Ä',
    invalidAddr: '–í–≤–µ–¥–∏—Ç–µ –≤–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å (0x + 40 —Å–∏–º–≤–æ–ª–æ–≤)',
    noTokens: '–ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ —Å –±–∞–ª–∞–Ω—Å–æ–º > $0.01',
    apiUnavailable: 'API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ Vercel –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –ø–æ Vercel-–∞–¥—Ä–µ—Å—É.',
    apiHint: '–ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏: –æ—Ç–∫—Ä–æ–π—Ç–µ debank.html?api=https://–≤–∞—à-vercel.vercel.app'
  },
  en: {
    lblAddr: 'Wallet address', btnLoad: 'üì° Load assets', lblTotal: 'Total balance',
    lblChains: 'Chains', lblTokens: 'Tokens', thToken: 'Token', thChain: 'Chain', thAmount: 'Amount', thUsd: 'USD',
    loading: 'Loading...', empty: 'Enter address and click Load', back: '‚Üê Tracker',
    invalidAddr: 'Enter valid address (0x + 40 chars)',
    noTokens: 'No tokens with balance > $0.01',
    apiUnavailable: 'API unavailable. Deploy to Vercel and open the site via your Vercel URL.',
    apiHint: 'If load fails: open debank.html?api=https://your-vercel.vercel.app'
  }
};
let lang = localStorage.getItem(LANG_KEY) || 'ru';
let theme = localStorage.getItem(THEME_KEY) || 'dark';

function setTheme(v) {
  theme = v; localStorage.setItem(THEME_KEY, v);
  document.documentElement.setAttribute('data-theme', v);
  document.getElementById('themeDark').classList.toggle('active', v === 'dark');
  document.getElementById('themeLight').classList.toggle('active', v === 'light');
}
function setLang(v) {
  lang = v; localStorage.setItem(LANG_KEY, v);
  document.documentElement.setAttribute('lang', v === 'ru' ? 'ru' : 'en');
  document.getElementById('langRu').classList.toggle('active', v === 'ru');
  document.getElementById('langEn').classList.toggle('active', v === 'en');
  document.getElementById('lblAddr').textContent = t[lang].lblAddr;
  document.getElementById('btnLoad').textContent = t[lang].btnLoad;
  document.getElementById('lblTotal').textContent = t[lang].lblTotal;
  document.getElementById('lblChains').textContent = t[lang].lblChains;
  document.getElementById('lblTokens').textContent = t[lang].lblTokens;
  document.getElementById('thToken').textContent = t[lang].thToken;
  document.getElementById('thChain').textContent = t[lang].thChain;
  document.getElementById('thAmount').textContent = t[lang].thAmount;
  document.getElementById('thUsd').textContent = t[lang].thUsd;
  document.getElementById('loading').textContent = t[lang].loading;
  document.getElementById('empty').textContent = t[lang].empty;
  document.querySelector('.btn-secondary').textContent = t[lang].back;
  const hint = document.getElementById('apiHint');
  if (hint) hint.textContent = t[lang].apiHint;
}
function fmt(n) {
  if (n == null || isNaN(n)) return '‚Äî';
  return Number(n).toLocaleString(lang === 'ru' ? 'ru-RU' : 'en-US', { maximumFractionDigits: 4, minimumFractionDigits: 0 });
}
function fmtUsd(n) {
  if (n == null || isNaN(n) || n < 0.01) return '$0';
  return '$' + Number(n).toLocaleString(lang === 'ru' ? 'ru-RU' : 'en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
}

async function loadAssets() {
  const addr = document.getElementById('addr').value.trim();
  const loadingEl = document.getElementById('loading');
  const errorEl = document.getElementById('error');
  const emptyEl = document.getElementById('empty');
  const summaryEl = document.getElementById('summaryCards');
  const tableEl = document.getElementById('tableWrap');
  const tbody = document.getElementById('tableBody');

  errorEl.style.display = 'none';
  emptyEl.style.display = 'none';
  summaryEl.style.display = 'none';
  tableEl.style.display = 'none';

  if (!addr || !/^0x[a-fA-F0-9]{40}$/.test(addr)) {
    errorEl.textContent = t[lang].invalidAddr;
    errorEl.style.display = 'block';
    return;
  }

  loadingEl.style.display = 'block';
  loadingEl.textContent = t[lang].loading;

  let base = new URLSearchParams(location.search).get('api');
  if (!base) {
    base = window.location.origin;
    if (window.location.hostname.includes('github.io')) base = VERCEL_API;
  }
  base = base.replace(/\/$/, '');
  const addrLower = addr.toLowerCase();

  try {
    const [balanceRes, tokenRes] = await Promise.all([
      fetch(`${base}/api/debank?path=user/total_balance&id=${encodeURIComponent(addrLower)}`),
      fetch(`${base}/api/debank?path=user/all_token_list&id=${encodeURIComponent(addrLower)}&is_all=false`)
    ]);

    if (balanceRes.status === 404 || tokenRes.status === 404) {
      loadingEl.style.display = 'none';
      errorEl.textContent = t[lang].apiUnavailable;
      errorEl.style.display = 'block';
      return;
    }

    let balance, tokens;
    try {
      balance = await balanceRes.json();
      tokens = await tokenRes.json();
    } catch (parseErr) {
      loadingEl.style.display = 'none';
      errorEl.textContent = t[lang].apiUnavailable;
      errorEl.style.display = 'block';
      return;
    }

    loadingEl.style.display = 'none';

    if (!balanceRes.ok) {
      errorEl.textContent = balance.error || balance.message || 'API error';
      errorEl.style.display = 'block';
      return;
    }

    const totalUsd = balance.total_usd_value ?? 0;
    const chainList = balance.chain_list || [];
    const chainCount = chainList.filter(c => (c.usd_value || 0) > 0).length;

    const tokenList = Array.isArray(tokens) ? tokens : [];
    const tokenCount = tokenList.length;

    summaryEl.style.display = 'grid';
    document.getElementById('totalValue').textContent = fmtUsd(totalUsd);
    document.getElementById('chainCount').textContent = chainCount;
    document.getElementById('tokenCount').textContent = tokenCount;

    tbody.innerHTML = '';
    tokenList
      .filter(tok => (tok.price || 0) * (tok.amount || 0) >= 0.01)
      .sort((a, b) => (b.price || 0) * (b.amount || 0) - (a.price || 0) * (a.amount || 0))
      .forEach(tok => {
        const usd = (tok.price || 0) * (tok.amount || 0);
        const symbol = tok.optimized_symbol || tok.symbol || tok.name || '?';
        const chain = tok.chain || '‚Äî';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="token-cell">
              ${tok.logo_url ? `<img src="${tok.logo_url}" alt="">` : ''}
              <div>
                <span class="symbol">${symbol}</span>
                <div class="name">${tok.name || ''}</div>
              </div>
            </div>
          </td>
          <td>${chain}</td>
          <td>${fmt(tok.amount)}</td>
          <td class="usd-value">${fmtUsd(usd)}</td>
        `;
        tbody.appendChild(tr);
      });

    tableEl.style.display = 'block';
    if (tbody.children.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted2);padding:32px;">' + t[lang].noTokens + '</td></tr>';
    }
  } catch (err) {
    loadingEl.style.display = 'none';
    const errMsg = lang === 'ru'
      ? '–ù–µ—Ç —Å–≤—è–∑–∏ —Å API. –£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π Vercel URL –≤ dashboard, –∑–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π—Ç–µ: debank.html?api=https://–≤–∞—à-–ø—Ä–æ–µ–∫—Ç.vercel.app'
      : 'No connection to API. Get your Vercel URL from dashboard, then open: debank.html?api=https://your-project.vercel.app';
    errorEl.innerHTML = errMsg;
    errorEl.style.display = 'block';
  }
}

document.documentElement.setAttribute('data-theme', theme);
document.getElementById('themeDark').classList.toggle('active', theme === 'dark');
document.getElementById('themeLight').classList.toggle('active', theme === 'light');
document.getElementById('langRu').classList.toggle('active', lang === 'ru');
document.getElementById('langEn').classList.toggle('active', lang === 'en');
setLang(lang);
</script>
</body>
</html>
